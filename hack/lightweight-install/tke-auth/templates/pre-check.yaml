apiVersion: batch/v1
kind: Job
metadata:
  name: tke-auth-pre-check
  namespace: tke
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "3"
    "helm.sh/hook-delete-policy": hook-succeeded, before-hook-creation
  labels:
    app: tke-auth-pre-check
spec:
  template:
    metadata:
      labels:
        app: tke-auth-pre-check
    spec:
      serviceAccountName: tke-hook-user
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: "NoSchedule"
      containers:
        - name: kubectl
          image: "{{ .Values.kubectl.image.repository }}:{{ .Values.kubectl.image.tag }}"
          imagePullPolicy: "{{ .Values.kubectl.image.imagePullPolicy}}"
          command: ['/bin/sh']
          args:
            - "-c"
            - |
              /bin/bash <<'EOF'
              #!/bin/bash
              check=true
              while [ $check = true ]
              do
                check=false
                if [ $check = false ] && [ $(kubectl get certificate -A 2>&1 | grep "error" | wc -l) -gt 0 ]; then
                  check=true
                  sleep 1
                fi
                if [ $check = false ] && [ $(kubectl get daemonset ingress-nginx-controller -n tke 2>&1 | grep Error | wc -l) -gt 0 ]; then
                  check=true
                  sleep 1
                fi 
                if [ $check = false ] && [ $(kubectl get daemonset ingress-nginx-controller -n tke -o jsonpath="{.status.desiredNumberScheduled}") -ne $(kubectl get daemonset ingress-nginx-controller -n tke -o jsonpath="{.status.numberReady}") ]; then
                  check=true
                  sleep 1
                fi
              done
              EOF
      restartPolicy: OnFailure